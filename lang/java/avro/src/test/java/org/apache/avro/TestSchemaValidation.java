/**
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
 * implied.  See the License for the specific language governing
 * permissions and limitations under the License.
 */

package org.apache.avro;

import java.util.ArrayList;

import org.junit.Assert;
import org.junit.Test;

public class TestSchemaValidation {
  Schema rec = new Schema.Parser().parse(
      "{\"type\":\"record\", \"name\":\"test.Rec\", \"fields\":" +
      "  [" +
      "    {\"name\":\"a\", \"type\":\"int\", \"default\":1}," +
      "    {\"name\":\"b\", \"type\":\"long\"}" +
      "  ]" +
      "}");
  Schema rec2 = new Schema.Parser().parse(
      "{\"type\":\"record\", \"name\":\"test.Rec\", \"fields\":" +
      "  [" +
      "    {\"name\":\"a\", \"type\":\"int\", \"default\":1}," +
      "    {\"name\":\"b\", \"type\":\"long\"}," +
      "    {\"name\":\"c\", \"type\":\"int\", \"default\":0}" +
      "  ]" +
      "}");
  Schema rec3 = new Schema.Parser().parse(
      "{\"type\":\"record\", \"name\":\"test.Rec\", \"fields\":" +
      "  [" +
      "    {\"name\":\"b\", \"type\":\"long\"}," +
      "    {\"name\":\"c\", \"type\":\"int\", \"default\":0}" +
      "  ]" +
      "}");

  Schema rec4 = new Schema.Parser().parse(
      "{\"type\":\"record\", \"name\":\"test.Rec\", \"fields\":" +
      "  [" +
      "    {\"name\":\"b\", \"type\":\"long\"}," +
      "    {\"name\":\"c\", \"type\":\"int\"}" +
      "  ]" +
      "}");

  Schema a = new Schema.Parser().parse("{\"type\":\"record\",\"name\":\"ApiCall\",\"namespace\":\"com.quixey.logging.api\",\"fields\":[{\"name\":\"common\",\"type\":{\"type\":\"record\",\"name\":\"APICommon\",\"fields\":[{\"name\":\"request_time\",\"type\":\"long\"},{\"name\":\"local_host\",\"type\":\"string\"},{\"name\":\"server_version\",\"type\":\"string\"},{\"name\":\"method\",\"type\":{\"type\":\"enum\",\"name\":\"HTTPMethod\",\"namespace\":\"com.quixey\",\"symbols\":[\"GET\",\"POST\",\"PUT\",\"DELETE\"]}},{\"name\":\"ip_address\",\"type\":\"string\"},{\"name\":\"referer\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"user_agent\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"response_size\",\"type\":\"int\"},{\"name\":\"processing_time\",\"type\":\"int\"},{\"name\":\"partner_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"partner_secret\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"partner_name\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"from_cache\",\"type\":[\"boolean\",\"null\"],\"default\":false},{\"name\":\"redirect_results\",\"type\":[\"boolean\",\"null\"],\"default\":false},{\"name\":\"prod\",\"type\":[\"boolean\",\"null\"],\"default\":false},{\"name\":\"session_key\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"unixtime\",\"type\":\"long\"}]}},{\"name\":\"event_type\",\"type\":\"string\"},{\"name\":\"search_event\",\"type\":[{\"type\":\"record\",\"name\":\"Search\",\"fields\":[{\"name\":\"q\",\"type\":\"string\"},{\"name\":\"skip\",\"type\":\"int\",\"default\":0},{\"name\":\"limit\",\"type\":\"int\",\"default\":10},{\"name\":\"edition_limit\",\"type\":\"int\",\"default\":3},{\"name\":\"platform_ids\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null},{\"name\":\"custom_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"min_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"max_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"include_editions\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_authors\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_platforms\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_screenshots\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_snippets\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_descriptions\",\"type\":\"boolean\",\"default\":false},{\"name\":\"fix_spelling\",\"type\":\"boolean\",\"default\":true},{\"name\":\"auto_filter\",\"type\":\"boolean\",\"default\":false},{\"name\":\"disable_cache\",\"type\":\"boolean\",\"default\":false},{\"name\":\"disable_lucene_cache\",\"type\":\"boolean\",\"default\":false},{\"name\":\"client_ip\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"geoloc\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"user_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"search_ms\",\"type\":\"int\"},{\"name\":\"search_id\",\"type\":\"string\"},{\"name\":\"result_count\",\"type\":\"int\"},{\"name\":\"restrict_editions\",\"type\":\"boolean\"},{\"name\":\"degraded\",\"type\":\"boolean\"},{\"name\":\"search_lms\",\"type\":[\"int\",\"null\"]},{\"name\":\"app_ids\",\"type\":{\"type\":\"array\",\"items\":\"long\"}},{\"name\":\"edition_ids_by_app_id\",\"type\":[{\"type\":\"map\",\"values\":{\"type\":\"array\",\"items\":\"long\"}},\"null\"],\"default\":null},{\"name\":\"correction\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"query_categorization\",\"type\":[{\"type\":\"map\",\"values\":\"double\"},\"null\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"event\",\"type\":[{\"type\":\"record\",\"name\":\"Event\",\"fields\":[{\"name\":\"event_type\",\"type\":\"string\"},{\"name\":\"search_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"app_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"edition_id\",\"type\":[\"long\",\"null\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"get_app\",\"type\":[{\"type\":\"record\",\"name\":\"GetApp\",\"fields\":[{\"name\":\"app_id\",\"type\":\"long\"},{\"name\":\"search_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"platform_ids\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null},{\"name\":\"custom_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"include_editions\",\"type\":\"boolean\",\"default\":true},{\"name\":\"min_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"max_cents\",\"type\":[\"int\",\"null\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"get_edition\",\"type\":[{\"type\":\"record\",\"name\":\"GetEdition\",\"fields\":[{\"name\":\"edition_id\",\"type\":\"long\"},{\"name\":\"search_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"custom_id\",\"type\":[\"long\",\"null\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"context_search\",\"type\":[{\"type\":\"record\",\"name\":\"ContextSearch\",\"fields\":[{\"name\":\"phrases\",\"type\":[{\"type\":\"array\",\"items\":\"string\"},\"null\"],\"default\":null},{\"name\":\"weights_by_phrase\",\"type\":[{\"type\":\"map\",\"values\":\"double\"},\"null\"],\"default\":null},{\"name\":\"skip\",\"type\":\"int\",\"default\":0},{\"name\":\"limit\",\"type\":\"int\",\"default\":10},{\"name\":\"edition_limit\",\"type\":\"int\",\"default\":3},{\"name\":\"platform_ids\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null},{\"name\":\"custom_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"min_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"max_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"include_editions\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_authors\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_platforms\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_screenshots\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_snippets\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_descriptions\",\"type\":\"boolean\",\"default\":false},{\"name\":\"fix_spelling\",\"type\":\"boolean\",\"default\":true},{\"name\":\"auto_filter\",\"type\":\"boolean\",\"default\":false},{\"name\":\"disable_cache\",\"type\":\"boolean\",\"default\":false},{\"name\":\"disable_lucene_cache\",\"type\":\"boolean\",\"default\":false},{\"name\":\"client_ip\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"geoloc\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"user_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"search_ms\",\"type\":\"int\"},{\"name\":\"search_id\",\"type\":\"string\"},{\"name\":\"result_count\",\"type\":\"int\"},{\"name\":\"restrict_editions\",\"type\":\"boolean\"},{\"name\":\"degraded\",\"type\":\"boolean\"},{\"name\":\"search_lms\",\"type\":[\"int\",\"null\"]},{\"name\":\"results\",\"type\":{\"type\":\"array\",\"items\":\"long\"}},{\"name\":\"edition_ids_by_app_id\",\"type\":{\"type\":\"map\",\"values\":{\"type\":\"array\",\"items\":\"long\"}}}]},\"null\"],\"default\":null},{\"name\":\"ads_log\",\"type\":[{\"type\":\"array\",\"items\":{\"type\":\"record\",\"name\":\"Ad\",\"namespace\":\"com.quixey.logging.api.ads\",\"fields\":[{\"name\":\"bid_type\",\"type\":\"string\"},{\"name\":\"display_url\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"headline\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"bid\",\"type\":\"int\"},{\"name\":\"campaign_id\",\"type\":\"string\"},{\"name\":\"destination_url\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"ecpm\",\"type\":\"int\"},{\"name\":\"ad_id\",\"type\":\"string\"},{\"name\":\"app\",\"type\":{\"type\":\"record\",\"name\":\"AdApp\",\"fields\":[{\"name\":\"id\",\"type\":\"long\"},{\"name\":\"editions\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null}]}}]}},\"null\"],\"default\":null},{\"name\":\"click_redirect\",\"type\":[{\"type\":\"record\",\"name\":\"ClickRedirect\",\"fields\":[{\"name\":\"search_id\",\"type\":\"string\"},{\"name\":\"identifier\",\"type\":\"string\"},{\"name\":\"exp\",\"type\":\"long\"},{\"name\":\"app_or_edition_id\",\"type\":\"long\"},{\"name\":\"status\",\"type\":\"string\"},{\"name\":\"ad_id\",\"type\":[\"string\",\"null\"]},{\"name\":\"dest\",\"type\":\"string\"},{\"name\":\"expires\",\"type\":\"string\"},{\"name\":\"id_type\",\"type\":{\"type\":\"enum\",\"name\":\"IdType\",\"symbols\":[\"app\",\"edition\"]}}]},\"null\"],\"default\":null}]}");
  Schema b = new Schema.Parser().parse("{\"type\":\"record\",\"name\":\"ApiCall\",\"namespace\":\"com.quixey.logging.api\",\"fields\":[{\"name\":\"common\",\"type\":{\"type\":\"record\",\"name\":\"APICommon\",\"fields\":[{\"name\":\"request_time\",\"type\":\"long\"},{\"name\":\"local_host\",\"type\":\"string\"},{\"name\":\"server_version\",\"type\":\"string\"},{\"name\":\"method\",\"type\":{\"type\":\"enum\",\"name\":\"HTTPMethod\",\"namespace\":\"com.quixey\",\"symbols\":[\"GET\",\"POST\",\"PUT\",\"DELETE\"]}},{\"name\":\"ip_address\",\"type\":\"string\"},{\"name\":\"referer\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"user_agent\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"response_size\",\"type\":\"int\"},{\"name\":\"processing_time\",\"type\":\"int\"},{\"name\":\"partner_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"partner_secret\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"partner_name\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"from_cache\",\"type\":[\"boolean\",\"null\"],\"default\":false},{\"name\":\"redirect_results\",\"type\":[\"boolean\",\"null\"],\"default\":false},{\"name\":\"prod\",\"type\":[\"boolean\",\"null\"],\"default\":false},{\"name\":\"session_key\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"unixtime\",\"type\":\"long\"}]}},{\"name\":\"event_type\",\"type\":\"string\"},{\"name\":\"search_event\",\"type\":[{\"type\":\"record\",\"name\":\"Search\",\"fields\":[{\"name\":\"q\",\"type\":\"string\"},{\"name\":\"skip\",\"type\":\"int\",\"default\":0},{\"name\":\"limit\",\"type\":\"int\",\"default\":10},{\"name\":\"edition_limit\",\"type\":\"int\",\"default\":3},{\"name\":\"platform_ids\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null},{\"name\":\"custom_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"min_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"max_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"include_editions\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_authors\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_platforms\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_screenshots\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_snippets\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_descriptions\",\"type\":\"boolean\",\"default\":false},{\"name\":\"fix_spelling\",\"type\":\"boolean\",\"default\":true},{\"name\":\"auto_filter\",\"type\":\"boolean\",\"default\":false},{\"name\":\"disable_cache\",\"type\":\"boolean\",\"default\":false},{\"name\":\"disable_lucene_cache\",\"type\":\"boolean\",\"default\":false},{\"name\":\"client_ip\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"geoloc\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"user_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"search_ms\",\"type\":\"int\"},{\"name\":\"search_id\",\"type\":\"string\"},{\"name\":\"result_count\",\"type\":\"int\"},{\"name\":\"restrict_editions\",\"type\":\"boolean\"},{\"name\":\"degraded\",\"type\":\"boolean\"},{\"name\":\"search_lms\",\"type\":[\"int\",\"null\"]},{\"name\":\"app_ids\",\"type\":{\"type\":\"array\",\"items\":\"long\"}},{\"name\":\"edition_ids_by_app_id\",\"type\":[{\"type\":\"map\",\"values\":{\"type\":\"array\",\"items\":\"long\"}},\"null\"],\"default\":null},{\"name\":\"correction\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"query_categorization\",\"type\":[{\"type\":\"map\",\"values\":\"double\"},\"null\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"event\",\"type\":[{\"type\":\"record\",\"name\":\"Event\",\"fields\":[{\"name\":\"event_type\",\"type\":\"string\"},{\"name\":\"search_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"app_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"edition_id\",\"type\":[\"long\",\"null\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"get_app\",\"type\":[{\"type\":\"record\",\"name\":\"GetApp\",\"fields\":[{\"name\":\"app_id\",\"type\":\"long\"},{\"name\":\"search_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"platform_ids\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null},{\"name\":\"custom_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"include_editions\",\"type\":\"boolean\",\"default\":true},{\"name\":\"min_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"max_cents\",\"type\":[\"int\",\"null\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"get_edition\",\"type\":[{\"type\":\"record\",\"name\":\"GetEdition\",\"fields\":[{\"name\":\"edition_id\",\"type\":\"long\"},{\"name\":\"search_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"custom_id\",\"type\":[\"long\",\"null\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"context_search\",\"type\":[{\"type\":\"record\",\"name\":\"ContextSearch\",\"fields\":[{\"name\":\"phrases\",\"type\":[{\"type\":\"array\",\"items\":\"string\"},\"null\"],\"default\":null},{\"name\":\"weights_by_phrase\",\"type\":[{\"type\":\"map\",\"values\":\"double\"},\"null\"],\"default\":null},{\"name\":\"skip\",\"type\":\"int\",\"default\":0},{\"name\":\"limit\",\"type\":\"int\",\"default\":10},{\"name\":\"edition_limit\",\"type\":\"int\",\"default\":3},{\"name\":\"platform_ids\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null},{\"name\":\"custom_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"min_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"max_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"include_editions\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_authors\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_platforms\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_screenshots\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_snippets\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_descriptions\",\"type\":\"boolean\",\"default\":false},{\"name\":\"fix_spelling\",\"type\":\"boolean\",\"default\":true},{\"name\":\"auto_filter\",\"type\":\"boolean\",\"default\":false},{\"name\":\"disable_cache\",\"type\":\"boolean\",\"default\":false},{\"name\":\"disable_lucene_cache\",\"type\":\"boolean\",\"default\":false},{\"name\":\"client_ip\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"geoloc\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"user_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"search_ms\",\"type\":\"int\"},{\"name\":\"search_id\",\"type\":\"string\"},{\"name\":\"result_count\",\"type\":\"int\"},{\"name\":\"restrict_editions\",\"type\":\"boolean\"},{\"name\":\"degraded\",\"type\":\"boolean\"},{\"name\":\"search_lms\",\"type\":[\"int\",\"null\"]},{\"name\":\"results\",\"type\":{\"type\":\"array\",\"items\":\"long\"}},{\"name\":\"edition_ids_by_app_id\",\"type\":{\"type\":\"map\",\"values\":{\"type\":\"array\",\"items\":\"long\"}}}]},\"null\"],\"default\":null},{\"name\":\"ads_log\",\"type\":[{\"type\":\"array\",\"items\":{\"type\":\"record\",\"name\":\"Ad\",\"namespace\":\"com.quixey.logging.api.ads\",\"fields\":[{\"name\":\"bid_type\",\"type\":\"string\"},{\"name\":\"display_url\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"headline\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"bid\",\"type\":\"int\"},{\"name\":\"campaign_id\",\"type\":\"string\"},{\"name\":\"destination_url\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"ecpm\",\"type\":\"int\"},{\"name\":\"ad_id\",\"type\":\"string\"},{\"name\":\"app\",\"type\":{\"type\":\"record\",\"name\":\"AdApp\",\"fields\":[{\"name\":\"id\",\"type\":\"long\"},{\"name\":\"editions\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null}]}}]}},\"null\"],\"default\":null},{\"name\":\"click_redirect\",\"type\":[{\"type\":\"record\",\"name\":\"ClickRedirect\",\"fields\":[{\"name\":\"search_id\",\"type\":\"string\",\"default\":\"\"},{\"name\":\"identifier\",\"type\":\"string\",\"default\":\"\"},{\"name\":\"exp\",\"type\":\"long\",\"default\":-1},{\"name\":\"app_or_edition_id\",\"type\":\"long\",\"default\":-1},{\"name\":\"status\",\"type\":\"string\",\"default\":\"\"},{\"name\":\"ad_id\",\"type\":[{\"type\":\"record\",\"name\":\"AdApp\",\"fields\":[{\"name\":\"id\",\"type\":\"long\", \"default\":-1},{\"name\":\"editions\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"dest\",\"type\":\"string\",\"default\":\"\"},{\"name\":\"expires\",\"type\":\"string\",\"default\":\"\"},{\"name\":\"id_type\",\"type\":{\"type\":\"enum\",\"name\":\"IdType\",\"symbols\":[\"app\",\"edition\"]},\"default\":\"app\"}]},\"null\"],\"default\":null}]}");
  Schema c = new Schema.Parser().parse("{\"type\":\"record\",\"name\":\"ApiCall\",\"namespace\":\"com.quixey.logging.api\",\"fields\":[{\"name\":\"common\",\"type\":{\"type\":\"record\",\"name\":\"APICommon\",\"fields\":[{\"name\":\"request_time\",\"type\":\"long\"},{\"name\":\"local_host\",\"type\":\"string\"},{\"name\":\"server_version\",\"type\":\"string\"},{\"name\":\"method\",\"type\":{\"type\":\"enum\",\"name\":\"HTTPMethod\",\"namespace\":\"com.quixey\",\"symbols\":[\"GET\",\"POST\",\"PUT\",\"DELETE\"]}},{\"name\":\"ip_address\",\"type\":\"string\"},{\"name\":\"referer\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"user_agent\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"response_size\",\"type\":\"int\"},{\"name\":\"processing_time\",\"type\":\"int\"},{\"name\":\"partner_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"partner_secret\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"partner_name\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"from_cache\",\"type\":[\"boolean\",\"null\"],\"default\":false},{\"name\":\"redirect_results\",\"type\":[\"boolean\",\"null\"],\"default\":false},{\"name\":\"prod\",\"type\":[\"boolean\",\"null\"],\"default\":false},{\"name\":\"session_key\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"unixtime\",\"type\":\"long\"}]}},{\"name\":\"event_type\",\"type\":\"string\"},{\"name\":\"search_event\",\"type\":[{\"type\":\"record\",\"name\":\"Search\",\"fields\":[{\"name\":\"q\",\"type\":\"string\"},{\"name\":\"skip\",\"type\":\"int\",\"default\":0},{\"name\":\"limit\",\"type\":\"int\",\"default\":10},{\"name\":\"edition_limit\",\"type\":\"int\",\"default\":3},{\"name\":\"platform_ids\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null},{\"name\":\"custom_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"min_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"max_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"include_editions\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_authors\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_platforms\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_screenshots\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_snippets\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_descriptions\",\"type\":\"boolean\",\"default\":false},{\"name\":\"fix_spelling\",\"type\":\"boolean\",\"default\":true},{\"name\":\"auto_filter\",\"type\":\"boolean\",\"default\":false},{\"name\":\"disable_cache\",\"type\":\"boolean\",\"default\":false},{\"name\":\"disable_lucene_cache\",\"type\":\"boolean\",\"default\":false},{\"name\":\"client_ip\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"geoloc\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"user_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"search_ms\",\"type\":\"int\"},{\"name\":\"search_id\",\"type\":\"string\"},{\"name\":\"result_count\",\"type\":\"int\"},{\"name\":\"restrict_editions\",\"type\":\"boolean\"},{\"name\":\"degraded\",\"type\":\"boolean\"},{\"name\":\"search_lms\",\"type\":[\"int\",\"null\"]},{\"name\":\"app_ids\",\"type\":{\"type\":\"array\",\"items\":\"long\"}},{\"name\":\"edition_ids_by_app_id\",\"type\":[{\"type\":\"map\",\"values\":{\"type\":\"array\",\"items\":\"long\"}},\"null\"],\"default\":null},{\"name\":\"correction\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"query_categorization\",\"type\":[{\"type\":\"map\",\"values\":\"double\"},\"null\"],\"default\":null},{\"name\":\"channel\",\"type\":[\"null\",\"string\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"event\",\"type\":[{\"type\":\"record\",\"name\":\"Event\",\"fields\":[{\"name\":\"event_type\",\"type\":\"string\"},{\"name\":\"search_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"app_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"edition_id\",\"type\":[\"long\",\"null\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"get_app\",\"type\":[{\"type\":\"record\",\"name\":\"GetApp\",\"fields\":[{\"name\":\"app_id\",\"type\":\"long\"},{\"name\":\"search_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"platform_ids\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null},{\"name\":\"custom_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"include_editions\",\"type\":\"boolean\",\"default\":true},{\"name\":\"min_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"max_cents\",\"type\":[\"int\",\"null\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"get_edition\",\"type\":[{\"type\":\"record\",\"name\":\"GetEdition\",\"fields\":[{\"name\":\"edition_id\",\"type\":\"long\"},{\"name\":\"search_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"custom_id\",\"type\":[\"long\",\"null\"],\"default\":null}]},\"null\"],\"default\":null},{\"name\":\"context_search\",\"type\":[{\"type\":\"record\",\"name\":\"ContextSearch\",\"fields\":[{\"name\":\"phrases\",\"type\":[{\"type\":\"array\",\"items\":\"string\"},\"null\"],\"default\":null},{\"name\":\"weights_by_phrase\",\"type\":[{\"type\":\"map\",\"values\":\"double\"},\"null\"],\"default\":null},{\"name\":\"skip\",\"type\":\"int\",\"default\":0},{\"name\":\"limit\",\"type\":\"int\",\"default\":10},{\"name\":\"edition_limit\",\"type\":\"int\",\"default\":3},{\"name\":\"platform_ids\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null},{\"name\":\"custom_id\",\"type\":[\"long\",\"null\"],\"default\":null},{\"name\":\"min_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"max_cents\",\"type\":[\"int\",\"null\"],\"default\":null},{\"name\":\"include_editions\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_authors\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_platforms\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_screenshots\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_snippets\",\"type\":\"boolean\",\"default\":true},{\"name\":\"include_descriptions\",\"type\":\"boolean\",\"default\":false},{\"name\":\"fix_spelling\",\"type\":\"boolean\",\"default\":true},{\"name\":\"auto_filter\",\"type\":\"boolean\",\"default\":false},{\"name\":\"disable_cache\",\"type\":\"boolean\",\"default\":false},{\"name\":\"disable_lucene_cache\",\"type\":\"boolean\",\"default\":false},{\"name\":\"client_ip\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"geoloc\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"user_id\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"search_ms\",\"type\":\"int\"},{\"name\":\"search_id\",\"type\":\"string\"},{\"name\":\"result_count\",\"type\":\"int\"},{\"name\":\"restrict_editions\",\"type\":\"boolean\"},{\"name\":\"degraded\",\"type\":\"boolean\"},{\"name\":\"search_lms\",\"type\":[\"int\",\"null\"]},{\"name\":\"results\",\"type\":{\"type\":\"array\",\"items\":\"long\"}},{\"name\":\"edition_ids_by_app_id\",\"type\":{\"type\":\"map\",\"values\":{\"type\":\"array\",\"items\":\"long\"}}}]},\"null\"],\"default\":null},{\"name\":\"ads_log\",\"type\":[{\"type\":\"array\",\"items\":{\"type\":\"record\",\"name\":\"Ad\",\"namespace\":\"com.quixey.logging.api.ads\",\"fields\":[{\"name\":\"bid_type\",\"type\":\"string\"},{\"name\":\"display_url\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"headline\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"bid\",\"type\":\"int\"},{\"name\":\"campaign_id\",\"type\":\"string\"},{\"name\":\"destination_url\",\"type\":[\"string\",\"null\"],\"default\":null},{\"name\":\"ecpm\",\"type\":\"int\"},{\"name\":\"ad_id\",\"type\":\"string\"},{\"name\":\"app\",\"type\":{\"type\":\"record\",\"name\":\"AdApp\",\"fields\":[{\"name\":\"id\",\"type\":\"long\"},{\"name\":\"editions\",\"type\":[{\"type\":\"array\",\"items\":\"long\"},\"null\"],\"default\":null}]}}]}},\"null\"],\"default\":null},{\"name\":\"click_redirect\",\"type\":[{\"type\":\"record\",\"name\":\"ClickRedirect\",\"fields\":[{\"name\":\"search_id\",\"type\":\"string\",\"default\":\"\"},{\"name\":\"identifier\",\"type\":\"string\",\"default\":\"\"},{\"name\":\"exp\",\"type\":\"long\",\"default\":-1},{\"name\":\"app_or_edition_id\",\"type\":\"long\",\"default\":-1},{\"name\":\"status\",\"type\":\"string\",\"default\":\"\"},{\"name\":\"ad_id\",\"type\":[\"null\",\"string\"],\"default\":null},{\"name\":\"dest\",\"type\":\"string\",\"default\":\"\"},{\"name\":\"expires\",\"type\":\"string\",\"default\":\"\"},{\"name\":\"id_type\",\"type\":{\"type\":\"enum\",\"name\":\"IdType\",\"symbols\":[\"app\",\"edition\"]},\"default\":\"app\"}]},\"null\"],\"default\":null}]}");

  @Test
  public void testReadOnePrior() throws SchemaValidationException {
    ArrayList<Schema> priors = new ArrayList<Schema>();
    priors.add(a);
    new SchemaValidatorBuilder().canReadStrategy().validateLatest().validate(c, priors);
  }

  @Test
  public void testReadAllPrior() throws SchemaValidationException {
    testValidator(new SchemaValidatorBuilder().canReadStrategy().validateAll(), rec4, rec, rec2, rec3);
  }

  @Test
  public void testOnePriorCanRead() throws SchemaValidationException {
    testValidator(new SchemaValidatorBuilder().canBeReadStrategy().validateAll(), rec, rec4);
  }

  @Test
  public void testAllPriorCanRead() throws SchemaValidationException {
    testValidator(new SchemaValidatorBuilder().canBeReadStrategy().validateAll(), rec, rec4, rec3, rec2);
  }

  @Test
  public void testOnePriorCompatible() throws SchemaValidationException {
    testValidator(new SchemaValidatorBuilder().mutualReadStrategy().validateLatest(), rec, rec4);
  }

  @Test
  public void testAllPriorCompatible() throws SchemaValidationException {
    testValidator(new SchemaValidatorBuilder().mutualReadStrategy().validateAll(), rec, rec4, rec3, rec2);
  }

  @Test(expected=AvroRuntimeException.class)
  public void testInvalidBuild() {
    new SchemaValidatorBuilder().strategy(null).validateAll();
  }

  private void testValidator(SchemaValidator validator,
      Schema schemaFails, Schema... schemaPrep) throws SchemaValidationException {
    ArrayList<Schema> prior = new ArrayList<Schema>();
    for(int i = schemaPrep.length - 1; i >= 0; i--) {
      prior.add(schemaPrep[i]);
    }
    boolean threw = false;
    try {
      // should fail
      validator.validate(schemaFails, prior);
    } catch (SchemaValidationException sve) {
      threw = true;
    }
    Assert.assertTrue(threw);
  }

}
